# Project 4: Copy-On-Write

이 프로젝트는 xv6 운영체제에서 `Copy-On-Write` 메커니즘을 구현하는 것을 목표로 합니다.

---

## 목차

- [프로젝트 개요](#프로젝트-개요)
- [Copy-On-Write 개념](#copy-on-write-개념)
- [구현 세부 사항](#구현-세부-사항)
  - [1. copyuvm() 함수 수정](#1-copyuvm-함수-수정)
  - [2. 페이지 참조 카운터 관리](#2-페이지-참조-카운터-관리)
  - [3. 페이지 폴트 핸들러 구현](#3-페이지-폴트-핸들러-구현)
- [테스트 프로그램](#테스트-프로그램)
- [참고 자료](#참고-자료)

---

## 프로젝트 개요

이 프로젝트에서는 xv6 운영체제에서 `Copy-On-Write` 기법을 구현합니다. `Copy-On-Write`는 프로세스가 `fork`될 때 부모와 자식이 동일한 메모리 페이지를 공유하지만, 한쪽에서 페이지를 수정하려고 할 때만 복사본이 생성되는 메커니즘입니다. 이를 통해 메모리 사용 효율을 높일 수 있습니다.


## Copy-On-Write 개념

- 프로세스가 `fork`될 때, 부모와 자식 프로세스는 동일한 물리 페이지를 읽기 전용으로 공유합니다.
- 공유된 페이지에 쓰기가 발생하면 페이지 폴트가 발생하고, 운영체제는 새로운 메모리 공간을 할당하여 해당 데이터를 기록합니다.
- 각 물리 페이지에는 참조 카운터가 필요하며, 이를 통해 페이지가 몇 개의 프로세스에 의해 공유되는지 추적합니다.


## 구현 세부 사항


### 1. `copyuvm()` 함수 수정

- `vm.c` 파일의 `copyuvm()` 함수를 수정하여, 부모 프로세스의 페이지를 자식 프로세스의 매핑 테이블에 복제할 때 새로운 페이지 할당 없이 매핑하도록 합니다.
- 페이지 테이블 엔트리(PTE)의 쓰기 가능 플래그(`PTE_W`)를 비활성화하여 쓰기 시도 시 페이지 폴트가 발생하도록 설정합니다.
- 물리 페이지의 참조 카운터를 증가시키고, `lcr3(V2P(pgdir))` 호출로 TLB를 플러시합니다.

### 2. 페이지 참조 카운터 관리

- `kalloc.c` 파일에 각 물리 페이지의 참조 카운터를 관리하는 배열을 추가합니다.
  - `uint pgrefcount[PHYSTOP >> PGSHIFT];`
- `freerange()`, `kfree()`, `kalloc()` 함수에서 참조 카운터를 적절히 초기화하고 관리합니다.
- 추가 함수:
  - `get_refcounter(uint pa)`: 주어진 물리 주소의 참조 카운터 반환.
  - `inc_refcounter(uint pa)`: 참조 카운터 증가.
  - `dec_refcounter(uint pa)`: 참조 카운터 감소.

### 3. 페이지 폴트 핸들러 구현

- `trap.c`와 `vm.c` 파일에서 페이지 폴트 핸들러를 구현합니다.
  - `rcr2()` 함수를 사용하여 페이지 폴트가 발생한 가상 주소를 가져옵니다.
  - 페이지가 유효한지 확인하고, 해당 페이지가 참조 카운트가 1보다 큰 경우 새로운 페이지를 할당하여 복사합니다.
  - 참조 카운트가 1인 경우 현재 페이지 테이블 엔트리의 쓰기 가능 플래그만 활성화합니다.
  - `lcr3(V2P(pgdir))` 호출로 TLB를 플러시합니다.


## 테스트 프로그램

테스트 프로그램을 작성하여 `Copy-On-Write`가 올바르게 작동하는지 확인합니다. 예를 들어, `fork` 후 메모리 사용량을 비교하여 `Copy-On-Write`가 정상적으로 적용되었는지 검사할 수 있습니다.


## 참고 자료

- xv6 소스 코드: [GitHub 링크](https://github.com/mit-pdos/xv6-public)
- xv6 해설서: [xv6 commentary PDF](https://pdos.csail.mit.edu/6.828/2018/xv6/book-rev11.pdf)
- xv6 관련 참고서적: [xv6 source booklet PDF](https://pdos.csail.mit.edu/6.828/2018/xv6/xv6-rev11.pdf)

